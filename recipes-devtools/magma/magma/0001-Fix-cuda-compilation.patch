From b6e7fe0843fe35e6350a55d47eaf4f70c640fa6b Mon Sep 17 00:00:00 2001
From: Kurt Kiefer <kurt.kiefer@arthrex.com>
Date: Thu, 28 Jul 2022 10:18:12 -0700
Subject: [PATCH] Fix cuda compilation

---
 CMakeLists.txt | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index ba53137..af9a572 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -276,6 +276,15 @@ if (MAGMA_ENABLE_CUDA)
         message( STATUS "    compile for CUDA arch 7.1 (Volta)" )
     endif()
 
+    if (GPU_TARGET MATCHES sm_72)
+        if (NOT MIN_ARCH)
+            set( MIN_ARCH 720 )
+        endif()
+        set( NV_SM ${NV_SM} -gencode arch=compute_72,code=sm_72 )
+        set( NV_COMP        -gencode arch=compute_72,code=compute_72 )
+        message( STATUS "    compile for CUDA arch 7.2 (Volta)" )
+    endif()
+
     if (GPU_TARGET MATCHES sm_75)
         if (NOT MIN_ARCH)
             set( MIN_ARCH 750 )
@@ -298,7 +307,11 @@ if (MAGMA_ENABLE_CUDA)
         message( FATAL_ERROR "GPU_TARGET must contain one or more of Fermi, Kepler, Maxwell, Pascal, Volta, Turing, Ampere, or valid sm_[0-9][0-9]" )
     endif()
 
-    set( CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} -Xcompiler -fPIC ${NV_SM} ${NV_COMP} ${FORTRAN_CONVENTION} )
+    if (CUDA_NVCC_FLAGS MATCHES ${GPU_TARGET})
+        string( REPLACE " " ";" CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} )
+    else()
+        set( CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} -Xcompiler -fPIC ${NV_SM} ${NV_COMP} ${FORTRAN_CONVENTION} )
+    endif()
     #add_definitions( "-DMAGMA_HAVE_CUDA -DMAGMA_CUDA_ARCH_MIN=${MIN_ARCH}" )
     set(MAGMA_HAVE_CUDA "1")
     set(MAGMA_CUDA_ARCH_MIN "${MIN_ARCH}")
