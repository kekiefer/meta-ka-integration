From d6d32cb86ddb8531923a001f1ff3e4c3922e6055 Mon Sep 17 00:00:00 2001
From: Kurt Kiefer <kurt.kiefer@arthrex.com>
Date: Thu, 14 Jul 2022 16:37:53 -0700
Subject: [PATCH] distutils: yocto-specific cross build support

---
 numpy/distutils/exec_command.py   | 5 +++++
 numpy/distutils/npy_pkg_config.py | 6 +++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/numpy/distutils/exec_command.py b/numpy/distutils/exec_command.py
index 79998cf..e9698e6 100644
--- a/numpy/distutils/exec_command.py
+++ b/numpy/distutils/exec_command.py
@@ -136,6 +136,10 @@ def find_executable(exe, path=None, _cache={}):
     if exe.startswith('"'):
         exe = exe[1:-1]
 
+    # handle sysroot flags included with compiler exe
+    exe = exe.split()[0]
+    exe_args = exe.split()[1:]
+
     suffixes = ['']
     if os.name in ['nt', 'dos', 'os2']:
         fn, ext = os.path.splitext(exe)
@@ -155,6 +159,7 @@ def find_executable(exe, path=None, _cache={}):
             if not os.path.islink(f_ext):
                 f_ext = realpath(f_ext)
             if os.path.isfile(f_ext) and os.access(f_ext, os.X_OK):
+                f_ext = " ".join([f_ext, *exe_args])
                 log.info('Found executable %s' % f_ext)
                 _cache[key] = f_ext
                 return f_ext
diff --git a/numpy/distutils/npy_pkg_config.py b/numpy/distutils/npy_pkg_config.py
index f6e3ad3..501d1a6 100644
--- a/numpy/distutils/npy_pkg_config.py
+++ b/numpy/distutils/npy_pkg_config.py
@@ -313,7 +313,11 @@ def _read_config_imp(filenames, dirs=None):
                              (pkgname, meta["name"]))
 
         mod = sys.modules[pkgname]
-        vars["pkgdir"] = _escape_backslash(os.path.dirname(mod.__file__))
+        pkgdir = os.path.dirname(mod.__file__)
+        # HACK: check if we should be cross-compiling and fix the path (Yocto)
+        if any(["recipe-sysroot/" in d for d in dirs]):
+            pkgdir = pkgdir.replace("recipe-sysroot-native/", "recipe-sysroot/")
+        vars["pkgdir"] = _escape_backslash(pkgdir)
 
     return LibraryInfo(name=meta["name"], description=meta["description"],
             version=meta["version"], sections=sections, vars=VariableSet(vars))
