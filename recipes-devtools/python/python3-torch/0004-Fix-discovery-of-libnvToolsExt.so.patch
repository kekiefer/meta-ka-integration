From 32edce3c0c881f7459ce2145216df422d8e2809a Mon Sep 17 00:00:00 2001
From: Kurt Kiefer <kurt.kiefer@arthrex.com>
Date: Fri, 22 Jul 2022 16:49:25 -0700
Subject: [PATCH] Fix discovery of libnvToolsExt.so

---
 cmake/TorchConfig.cmake.in | 2 +-
 cmake/public/cuda.cmake    | 7 +++++--
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/cmake/TorchConfig.cmake.in b/cmake/TorchConfig.cmake.in
index 935a9846..011e9fca 100644
--- a/cmake/TorchConfig.cmake.in
+++ b/cmake/TorchConfig.cmake.in
@@ -148,7 +148,7 @@ if(@USE_CUDA@)
       ${CUDA_TOOLKIT_ROOT_DIR}/lib/libnvToolsExt.dylib
       ${CUDA_LIBRARIES})
   else()
-    find_library(LIBNVTOOLSEXT libnvToolsExt.so PATHS ${CUDA_TOOLKIT_ROOT_DIR}/lib64/)
+    find_library(LIBNVTOOLSEXT libnvToolsExt.so HINTS ${CUDA_TOOLKIT_ROOT_DIR} PATH_SUFFIXES lib lib64 lib/x64)
     set(TORCH_CUDA_LIBRARIES
       ${CUDA_CUDA_LIB}
       ${CUDA_NVRTC_LIB}
diff --git a/cmake/public/cuda.cmake b/cmake/public/cuda.cmake
index 9249b01a..d5d8334c 100644
--- a/cmake/public/cuda.cmake
+++ b/cmake/public/cuda.cmake
@@ -35,6 +35,9 @@ if(NOT CUDA_FOUND)
   set(CAFFE2_USE_CUDA OFF)
   return()
 endif()
+
+set(CUDA_TOOLKIT_ROOT_DIR ${CMAKE_CUDA_TOOLKIT_TARGET_DIR})
+
 message(STATUS "Caffe2: CUDA detected: " ${CUDA_VERSION})
 message(STATUS "Caffe2: CUDA nvcc is: " ${CUDA_NVCC_EXECUTABLE})
 message(STATUS "Caffe2: CUDA toolkit directory: " ${CUDA_TOOLKIT_ROOT_DIR})
@@ -188,7 +191,7 @@ find_library(CUDA_CUDA_LIB cuda
     PATHS ${CUDA_TOOLKIT_ROOT_DIR}
     PATH_SUFFIXES lib lib64 lib/stubs lib64/stubs lib/x64)
 find_library(CUDA_NVRTC_LIB nvrtc
-    PATHS ${CUDA_TOOLKIT_ROOT_DIR}
+    HINTS ${CUDA_TOOLKIT_ROOT_DIR}
     PATH_SUFFIXES lib lib64 lib/x64)
 if(CUDA_NVRTC_LIB AND NOT CUDA_NVRTC_SHORTHASH)
   if("${PYTHON_EXECUTABLE}" STREQUAL "")
@@ -268,7 +271,7 @@ elseif(APPLE)
       ${CUDA_TOOLKIT_ROOT_DIR}/lib/libnvToolsExt.dylib)
 
 else()
-  find_library(LIBNVTOOLSEXT libnvToolsExt.so PATHS ${CUDA_TOOLKIT_ROOT_DIR}/lib64/)
+  find_library(LIBNVTOOLSEXT libnvToolsExt.so HINTS ${CUDA_TOOLKIT_ROOT_DIR} PATH_SUFFIXES lib lib64 lib/x64)
   set_property(
       TARGET torch::nvtoolsext PROPERTY INTERFACE_LINK_LIBRARIES
       ${LIBNVTOOLSEXT})
